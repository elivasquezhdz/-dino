<!--ESTE ES EL BUENO-->
<html>
<head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <!-- Load BodyPix -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
    <!-- Load tflite -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.6/dist/tf-tflite.min.js"></script>


</head>
<body>
    <p id="status">OpenCV.js is loading...</p>
    <div>
        <img id='image' src='images/yocrop.jpg' crossorigin='anonymous'/>
    </div>
    <div><canvas id="mask"></canvas></div>
    <div><canvas id="nobg"></canvas></div>
    <div><canvas id="rect"></canvas></div>
    <div><canvas id="rect1"></canvas></div>
    <div><canvas id="rect2"></canvas></div>
    <div class="result-container">
        <canvas id="cartoon" width="224px" height="224px" class="hide"></canvas>
    </div>


</body>
<!--<script  type="text/javascript"
 src="index.js"    ></script>-->
 <script>
    function onOpenCvReady() {
        document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
        const nobg = document.getElementById('nobg');
        const mask = document.getElementById('mask');
        const img = document.getElementById('image');
//const tfliteModel =  tflite.loadTFLiteModel("https://storage.googleapis.com/tfweb/models/cartoongan_fp16.tflite",)


async function execute() {
    const net = await bodyPix.load(/** optional arguments, see below **/);
    /**
     * One of (see documentation below):
     *   - net.segmentPerson
     *   - net.segmentPersonParts
     *   - net.segmentMultiPerson
     *   - net.segmentMultiPersonParts
     * See documentation below for details on each method.
     */

    let original_img = cv.imread(img);
    let cartoon = cv.imread("cartoon")
    let cartoon_resized = new cv.Mat();




    w = original_img.cols; h = original_img.rows;

    let dsize = new cv.Size(w, h);
    cv.resize(cartoon, cartoon_resized, dsize, 0, 0, cv.INTER_AREA);
    //dsize = new cv.Size(w/10, h/10);
    //cv.resize(cartoon_resized, cartoon_resized, dsize, 0, 0, cv.INTER_AREA);
    /*dsize = new cv.Size(150, 150);
    cv.resize(cartoon_resized, cartoon_resized, dsize, 0, 0, cv.INTER_AREA);*/

    cv.imshow('cartoon', cartoon_resized);

    const cartoon_cv = document.getElementById("cartoon");
  
    const segmentation = await net.segmentPerson(cartoon_cv);
    const foregroundColor = {r: 0, g: 0, b: 0, a: 0};
    const backgroundColor = {r: 255, g: 255, b:255, a: 255};

    const foregroundColor2 = {r:255, g: 255, b: 255, a: 255};
    const backgroundColor2 = {r: 0, g: 0, b: 0, a: 255};

    const backgroundDarkeningMask = bodyPix.toMask(segmentation, foregroundColor, backgroundColor);

    const backgroundDarkeningMask2 = bodyPix.toMask(segmentation, foregroundColor2, backgroundColor2);    
    const opacity = 1;
    const flipHorizontal = false;
    const maskBlurAmount = 2;
    bodyPix.drawMask(  nobg, cartoon_cv, backgroundDarkeningMask, opacity, maskBlurAmount,  flipHorizontal);  

    bodyPix.drawMask(mask, cartoon_cv, backgroundDarkeningMask2, opacity, maskBlurAmount,  flipHorizontal);

    let nobgimg =  cv.imread('nobg');
    let src = cv.imread('mask');
    let rectangular_image = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);
    cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);
    cv.threshold(src, src, 177, 200, cv.THRESH_BINARY);
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(src, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);
    let cnt = contours.get(0);
    // You can try more different parameters
    let rect = cv.boundingRect(cnt);
    rectangular_image = nobgimg.roi(rect);
    cv.imshow('rect',rectangular_image);
    src.delete(); contours.delete(); hierarchy.delete(); cnt.delete();



    let dst = new cv.Mat();
    dsize = new cv.Size(rectangular_image.cols, rectangular_image.rows);

    let center = new cv.Point(rectangular_image.cols / 2, rectangular_image.rows / 2);
    let M = cv.getRotationMatrix2D(center, -3, 1);
    cv.warpAffine(rectangular_image, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
    cv.imshow('rect1', dst);
    
    M = cv.getRotationMatrix2D(center, 3, 1);
    cv.warpAffine(rectangular_image, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
    cv.imshow('rect2', dst);

    M.delete(); dst.delete(); cartoon.delete(); cartoon_resized.delete(); rectangular_image.delete();
    await delete_images();
  }

async function delete_images(){
let to_delete = document.getElementById("image");
    to_delete.parentElement.removeChild(to_delete);

    to_delete = document.getElementById("nobg");
    to_delete.parentElement.removeChild(to_delete);    

    to_delete = document.getElementById("mask");
    to_delete.parentElement.removeChild(to_delete);

    to_delete = document.getElementById("cartoon");
    to_delete.parentElement.removeChild(to_delete);

}


execute();

}
    </script>
    <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

</html>

